{% extends "base.html" %}

{% if character %}
    {% set page_title = "Редактирование персонажа" %}
{% else %}
    {% set page_title = "Новый персонаж" %}
{% endif %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='admin.css') }}">
{% endblock %}

{% block content %}
<div class="card">
    <h1>{{ page_title }}</h1>
    <form method="post">
        <div class="form-grid">
            <label>Имя
                <input type="text" name="name" value="{{ character.name if character else '' }}" required>
            </label>
            <label>Slug (url)
                <input type="text" name="slug" value="{{ character.slug if character else '' }}" required>
            </label>

            <label>Класс
                {% set cls = character.class_name if character else '' %}
                <select name="class_name">
                    <option value="">Не указан</option>
                    <option value="Дуэлянт" {% if cls=='Дуэлянт' %}selected{% endif %}>Дуэлянт</option>
                    <option value="Страж" {% if cls=='Страж' %}selected{% endif %}>Страж</option>
                    <option value="Поддержка" {% if cls=='Поддержка' %}selected{% endif %}>Поддержка</option>
                    <option value="Штурмовик" {% if cls=='Штурмовик' %}selected{% endif %}>Штурмовик</option>
                    <option value="Манипулятор" {% if cls=='Манипулятор' %}selected{% endif %}>Манипулятор</option>
                </select>
            </label>

            <label>Фракция
                {% set f = character.faction if character else '' %}
                <select name="faction">
                    <option value="">Не указана</option>
                    <option value="Ножницы" {% if f=='Ножницы' %}selected{% endif %}>Ножницы</option>
                    <option value="Урбино" {% if f=='Урбино' %}selected{% endif %}>Урбино</option>
                    <option value="СТУ" {% if f=='СТУ' %}selected{% endif %}>СТУ</option>
                </select>
            </label>

            {% set tw = character.tier_weapon if character else '' %}
            {% set ts = character.tier_skill if character else '' %}
            {% set tp = character.tier_passive if character else '' %}
            {% set tu = character.tier_ultimate if character else '' %}
            {% set tier_options = ['D','C','B','A','S','SS','SSS'] %}

            <label>Тир (Оружие)
                <select name="tier_weapon">
                    <option value="">-</option>
                    {% for v in tier_options %}
                    <option value="{{ v }}" {% if tw==v %}selected{% endif %}>{{ v }}</option>
                    {% endfor %}
                </select>
            </label>

            <label>Тир (Навык)
                <select name="tier_skill">
                    <option value="">-</option>
                    {% for v in tier_options %}
                    <option value="{{ v }}" {% if ts==v %}selected{% endif %}>{{ v }}</option>
                    {% endfor %}
                </select>
            </label>

            <label>Тир (Пассивная способность)
                <select name="tier_passive">
                    <option value="">-</option>
                    {% for v in tier_options %}
                    <option value="{{ v }}" {% if tp==v %}selected{% endif %}>{{ v }}</option>
                    {% endfor %}
                </select>
            </label>

            <label>Тир (Ультимейт)
                <select name="tier_ultimate">
                    <option value="">-</option>
                    {% for v in tier_options %}
                    <option value="{{ v }}" {% if tu==v %}selected{% endif %}>{{ v }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>Имя файла изображения (без расширения)
                <input type="text" name="image_name"
                       value="{{ character.image_name.rsplit('.', 1)[0] if character and character.image_name else '' }}">
            </label>
            <label>Сложность освоения
                {% set raw_diff = character.difficulty if character else '' %}
                {% set diff = 'Лёгкий' if raw_diff == 'Для новичков' else raw_diff %}
                <select name="difficulty">
                    <option value="">Не указана</option>
                    <option value="Лёгкий" {% if diff=='Лёгкий' %}selected{% endif %}>Лёгкий</option>
                    <option value="Сложный" {% if diff=='Сложный' %}selected{% endif %}>Сложный</option>
                    <option value="Средний" {% if diff=='Средний' %}selected{% endif %}>Средний</option>
                </select>
            </label>
        </div>
        <label>Краткое резюме
            <textarea name="short_summary" rows="4">{{ character.short_summary if character else '' }}</textarea>
        </label>

        <label>Обзор
            <textarea name="review" rows="8">{{ character.review if character else '' }}</textarea>
        </label>

        <div class="skills-form">
            <div class="skills-form__header">
                <h2>Навыки</h2>
                <button type="button" class="btn btn-ghost" id="add-skill-btn">Добавить навык</button>
            </div>
            <div id="skills-list">
                {% set skills = character.skills if character and character.skills else [None] %}
                {% for skill in skills %}
                    <div class="skill-form-row">
                        <input type="hidden" name="skill_id" value="{{ skill.id if skill else '' }}">
                        <label>Название навыка
                            <input type="text" name="skill_name" value="{{ skill.name if skill else '' }}" placeholder="Напр. Striker Kick">
                        </label>
                        <label>Тип
                            <input type="text" name="skill_type" value="{{ skill.type if skill else '' }}" placeholder="Ультимейт / Пассивка / Навык">
                        </label>
                        <label>Описание
                            <textarea name="skill_description" rows="3" placeholder="Кратко опишите механику">{{ skill.description if skill else '' }}</textarea>
                        </label>
                        <label>Кулдаун
                            <input type="text" name="skill_cooldown" value="{{ skill.cooldown if skill else '' }}" placeholder="Напр. 12с">
                        </label>
                    </div>
                {% endfor %}
            </div>
        </div>

        <button type="submit">Сохранить</button>
    </form>

    <template id="skill-template">
        <div class="skill-form-row">
            <input type="hidden" name="skill_id" value="">
            <label>Название навыка
                <input type="text" name="skill_name" value="" placeholder="Напр. Striker Kick">
            </label>
            <label>Тип
                <input type="text" name="skill_type" value="" placeholder="Ультимейт / Пассивка / Навык">
            </label>
            <label>Описание
                <textarea name="skill_description" rows="3" placeholder="Кратко опишите механику"></textarea>
            </label>
            <label>Кулдаун
                <input type="text" name="skill_cooldown" value="" placeholder="Напр. 12с">
            </label>
        </div>
    </template>

    <script>
        const skillsList = document.getElementById('skills-list');
        const template = document.getElementById('skill-template');
        const addBtn = document.getElementById('add-skill-btn');

        addBtn?.addEventListener('click', () => {
            const clone = template.content.cloneNode(true);
            skillsList.appendChild(clone);
            addBtn.blur();
        });
    </script>
</div>
{% endblock %}