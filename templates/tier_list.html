{% extends "base.html" %}
{% import "_macros.html" as macros %}

{% block title %}Tier List{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='tier_list.css') }}">
{% endblock %}

{% block page_class %}tier-page{% endblock %}

{% block content %}
<!-- Обертка с фильтрами для поиска и сортировок по фракции/классу -->
<div class="card tier-filters">
    <form class="filters" method="get" id="filter-form">
        <div class="filters-bar">
            <!-- Поле для текстового поиска по имени персонажа -->
            <div class="search-input">
                <input type="text" name="search" id="search" placeholder="Поиск персонажей..." value="{{ request.args.get('search', '') }}">
            </div>

            {% set f = active_faction %}
            <input type="hidden" name="faction" value="{{ f }}" id="faction-input">
            <!-- Кнопки выбора фракции: справа от поиска, * означает любую фракцию -->
            <div class="chip-group faction-filters" aria-label="Фракция">
                <button type="button" class="chip {% if f == '*' %}active{% endif %}" data-target="faction-input" data-value="*">*</button>
                {% for name in available_factions %}
                <button type="button" class="chip {% if f == name %}active{% endif %}" data-target="faction-input" data-value="{{ name }}">{{ name }}</button>
                {% endfor %}
            </div>
        </div>

        <div class="filters-row">
            {% set cls = active_class %}
            <input type="hidden" name="class_name" value="{{ cls }}" id="class-input">
            <!-- Кнопки выбора класса: располагаются под строкой поиска, * означает любой класс -->
            <div class="chip-group class-filters" aria-label="Класс">
                <button type="button" class="chip {% if cls == '*' %}active{% endif %}" data-target="class-input" data-value="*">*</button>
                {% for name in available_classes %}
                <button type="button" class="chip {% if cls == name %}active{% endif %}" data-target="class-input" data-value="{{ name }}">{{ name }}</button>
                {% endfor %}
            </div>

            {% set diff = active_difficulty %}
            <input type="hidden" name="difficulty" value="{{ diff }}" id="difficulty-input">
            <div class="chip-group difficulty-filters" aria-label="Сложность">
                <button type="button" class="chip {% if diff == '*' %}active{% endif %}" data-target="difficulty-input" data-value="*">*</button>
                {% for name in available_difficulties %}
                <button type="button" class="chip {% if diff == name %}active{% endif %}" data-target="difficulty-input" data-value="{{ name }}">{{ difficulty_labels.get(name, name) }}</button>                {% endfor %}
            </div>
        </div>
    </form>
</div>

<!-- Список рядов тир-листа: маркер слева, иконки выровнены по левому краю -->
{% for tier in ['SSS', 'SS', 'S', 'A', 'B', 'C', 'D', 'Unranked'] %}
    {% set chars = tiers.get(tier, []) %}
    {% if chars %}
    <div class="tier-row">
        <div class="tier-marker tier-{{ tier|lower }}">{{ tier }}</div>
        <div class="tier-grid">
            {% for ch in chars %}
            <a class="tier-icon" href="{{ url_for('character_detail', slug=ch.slug) }}">
                <div class="icon-frame">
                    {{ macros.character_image(ch.image_name, ch.name, size='icon', placeholder=ch.name[0]) }}
                    <div class="icon-overlay">
                        <div class="overlay-avatar">
                            {{ macros.character_image(ch.image_name, ch.name, size='small', placeholder=ch.name[0]) }}
                        </div>
                        <div class="overlay-name">{{ ch.name }}</div>
                        <div class="overlay-meta overlay-tags">
                            <span class="tag">{{ ch.faction or '—' }}</span>
                            <span class="tag">{{ ch.class_name or '—' }}</span>
                            <span class="tag">{{ difficulty_labels.get(ch.difficulty, ch.difficulty or '—') }}</span>
                        </div>
                        <div class="overlay-ratings">
                            <div class="rating-pill tier-pill tier-{{ (ch.tier_weapon or 'none')|lower }}">Оружие: {{ ch.tier_weapon or '-' }}</div>
                            <div class="rating-pill tier-pill tier-{{ (ch.tier_skill or 'none')|lower }}">Навык: {{ ch.tier_skill or '-' }}</div>
                            <div class="rating-pill tier-pill tier-{{ (ch.tier_passive or 'none')|lower }}">Пассивка: {{ ch.tier_passive or '-' }}</div>
                            <div class="rating-pill tier-pill tier-{{ (ch.tier_ultimate or 'none')|lower }}">Ультимейт: {{ ch.tier_ultimate or '-' }}</div>
                        </div>
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
{% endfor %}

<script>
    // Обработчики для поиска и переключателей фракции/класса
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('filter-form');
        const search = document.getElementById('search');
        let debounceId;

        const submitWithCurrentFilters = () => {
            const params = new URLSearchParams(window.location.search);
            const formData = new FormData(form);

            formData.forEach((value, key) => {
                params.set(key, value);
            });

            const url = new URL(window.location.href);
            url.search = params.toString();
            window.location.href = url.toString();
        };

        // Отправляем форму с задержкой, чтобы не спамить запросы при вводе
        search.addEventListener('input', () => {
            clearTimeout(debounceId);
            debounceId = setTimeout(submitWithCurrentFilters, 150);
        });

        // Переключение активного чипа и отправка формы
        document.querySelectorAll('.chip').forEach(btn => {
            btn.addEventListener('click', () => {
                const target = document.getElementById(btn.dataset.target);
                const value = btn.dataset.value;

                document.querySelectorAll(`.chip[data-target="${btn.dataset.target}"]`).forEach(el => el.classList.remove('active'));
                btn.classList.add('active');
                target.value = value;
                submitWithCurrentFilters();
            });
        });
    });
</script>
{% endblock %}
