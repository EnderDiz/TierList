{% extends "base.html" %}
{% import "_macros.html" as macros %}

{% block title %}Tier List{% endblock %}

{% block content %}
<div class="card tier-filters">
    <form class="filters" method="get" id="filter-form">
        <input type="text" name="search" id="search" placeholder="Search characters" value="{{ request.args.get('search', '') }}">

        {% set cls = request.args.get('class_name') %}
        <input type="hidden" name="class_name" value="{{ cls }}" id="class-input">
        <div class="chip-group" aria-label="Класс">
            <button type="button" class="chip {% if not cls %}active{% endif %}" data-target="class-input" data-value="">Любой класс</button>
            {% for name in available_classes %}
            <button type="button" class="chip {% if cls == name %}active{% endif %}" data-target="class-input" data-value="{{ name }}">{{ name }}</button>
            {% endfor %}
        </div>

        {% set f = request.args.get('faction') %}
        <input type="hidden" name="faction" value="{{ f }}" id="faction-input">
        <div class="chip-group" aria-label="Фракция">
            <button type="button" class="chip {% if not f %}active{% endif %}" data-target="faction-input" data-value="">Любая фракция</button>
            {% for name in available_factions %}
            <button type="button" class="chip {% if f == name %}active{% endif %}" data-target="faction-input" data-value="{{ name }}">{{ name }}</button>
            {% endfor %}
        </div>
    </form>
</div>

{% for tier in ['SSS', 'SS', 'S', 'A', 'B', 'C', 'D', 'Unranked'] %}
    {% set chars = tiers.get(tier, []) %}
    {% if chars %}
    <div class="tier-row">
        <div class="tier-grid">
            {% for ch in chars %}
            <a class="tier-icon" href="{{ url_for('character_detail', slug=ch.slug) }}">
                <div class="icon-frame">
                    {{ macros.character_image(ch.image_name, ch.name, size='icon', placeholder=ch.name[0]) }}
                    <div class="icon-overlay">
                        <div class="overlay-name">{{ ch.name }}</div>
                        <div class="overlay-meta">{{ ch.class_name or '—' }} · {{ ch.faction or '—' }}</div>
                        <div class="overlay-meta subtle">Сложность: {{ ch.difficulty or '—' }}</div>
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
        <div class="tier-marker tier-{{ tier|lower }}">{{ tier }}</div>
    </div>
    {% endif %}
{% endfor %}

<script>
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('filter-form');
    const search = document.getElementById('search');
    let debounceId;

    search.addEventListener('input', () => {
        clearTimeout(debounceId);
        debounceId = setTimeout(() => form.requestSubmit(), 150);
    });

    document.querySelectorAll('.chip').forEach(btn => {
        btn.addEventListener('click', () => {
            const target = document.getElementById(btn.dataset.target);
            const value = btn.dataset.value;

            document.querySelectorAll(`.chip[data-target="${btn.dataset.target}"]`).forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
            target.value = value;
            form.requestSubmit();
        });
    });
});
</script>
{% endblock %}
